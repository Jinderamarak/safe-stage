include:
  - pipeline/templates.yml

collisioner:lint:
  extends: .rust-template
  stage: lint
  needs:
    - job: cache:cargo
      optional: true
  script:
    - rustup component add rustfmt
    - cargo fmt -p collisioner -- --check
    - rustup component add clippy
    - cargo clippy -p collisioner -- -D warnings

collisioner:build:
  extends: .rust-template
  stage: build
  needs:
    - collisioner:lint
    - job: cache:cargo
      optional: true
  script:
    - cargo build -p collisioner --locked

collisioner:test:
  extends: .rust-template
  stage: test
  needs:
    - collisioner:lint
    - collisioner:build
    - job: cache:cargo
      optional: true
  before_script:
    - mkdir -p ${CARGO_HOME}/bin
    - curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C ${CARGO_HOME}/bin
  script:
    - cargo nextest run --config-file .nextest.toml -p collisioner --locked
  artifacts:
    when: always
    reports:
      junit:
        - target/nextest/default/junit-report.xml

collisioner:test-docs:
  extends: .rust-template
  stage: test
  needs:
    - collisioner:lint
    - collisioner:build
    - job: cache:cargo
      optional: true
  script:
    - cargo test -p collisioner --doc --locked

# Optional build on nightly channel
collisioner:build:nightly:
  stage: build
  image:
    name: rustlang/rust:nightly
    pull_policy: always
  needs:
    - collisioner:lint
    - collisioner:build
  script:
    - cargo build -p collisioner
  allow_failure: true
