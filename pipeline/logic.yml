include:
  - pipeline/templates.yml

.logic-template:
  extends: .rust-template
  variables:
    LOGIC_PROJECTS: -p collisioner -p mather

logic:lint:
  extends: .logic-template
  stage: lint
  needs:
    - job: cargo:cache
      optional: true
  script:
    - rustup component add rustfmt
    - cargo fmt ${LOGIC_PROJECTS} -- --check
    - rustup component add clippy
    - cargo clippy ${LOGIC_PROJECTS} -- -D warnings

logic:build:
  extends: .logic-template
  stage: build
  needs:
    - logic:lint
    - job: cargo:cache
      optional: true
  script:
    - cargo build ${LOGIC_PROJECTS} --locked

logic:test:
  extends: .logic-template
  stage: test
  needs:
    - logic:lint
    - logic:build
    - job: cargo:cache
      optional: true
  before_script:
    - mkdir -p ${CARGO_HOME}/bin
    - curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C ${CARGO_HOME}/bin
  script:
    - cargo nextest run --config-file .nextest.toml ${LOGIC_PROJECTS} --locked
  artifacts:
    when: always
    reports:
      junit:
        - target/nextest/default/junit-report.xml

logic:test:docs:
  extends: .logic-template
  stage: test
  needs:
    - logic:lint
    - logic:build
    - job: cargo:cache
      optional: true
  script:
    - cargo test ${LOGIC_PROJECTS} --doc --locked

# Optional build on nightly channel
logic:build:nightly:
  extends: .logic-template
  stage: build
  image:
    name: rustlang/rust:nightly
    pull_policy: always
  needs:
    - logic:lint
    - logic:build
  script:
    - cargo build ${LOGIC_PROJECTS}
  allow_failure: true
